# HPTourism Portal v0.7.1 - Platform Architecture

## 1. High-Level Architecture Diagram

```mermaid
graph TD
    User[用户 / Citizen] -->|HTTPS| LoadBalancer[Nginx Reverse Proxy]
    LoadBalancer -->|Proxiess :5050| AppServer[App Server (Node.js/Express)]
    
    subgraph "Application Server (v0.7.1)"
        Frontend[React SPA (Vite)] -- "API Calls" --> Backend[Express API]
        Backend -->|Auth| Passport[Passport.js / Session]
        Backend -->|Data| Drizzle[Drizzle ORM]
        Backend -->|File Storage| ObjectStore[Local Storage / S3 Adapter]
    end
    
    subgraph "Data Layer"
        Drizzle -->|SQL| DB[(PostgreSQL 14+)]
        ObjectStore -->|FS| Disk[Local Disk (/data/uploads)]
    end
    
    subgraph "External Integrations"
        Backend -->|Payment| HimKosh[HimKosh Payment Gateway]
        Backend -->|SMS| NIC_SMS[NIC SMS Gateway]
        Backend -->|Email| GovEmail[Gov Email Relay]
    end
```

## 2. Core Modules

### 2.1 Frontend (Client)
- **Framework**: React 18 with Typescript.
- **Build Tool**: Vite.
- **UI Library**: TailwindCSS, Shadcn/UI (Radix Primitives).
- **Communication**: React Query (TanStack Query) for API state management.
- **Routing**: Wouter (Lightweight routing).

### 2.2 Backend (Server)
- **Runtime**: Node.js v20+.
- **Framework**: Express.js.
- **ORM**: Drizzle ORM (Type-safe SQL).
- **Session Management**: `express-session` backed by PostgreSQL (`connect-pg-simple`).
- **Security**: Helmet, Rate Limitting, Input Validation (Zod).

### 2.3 Database
- **Engine**: PostgreSQL 14+.
- **Schema**: Managed via Drizzle Schema (`shared/schema.ts`).
- **Migrations**: Automated via `drizzle-kit push`.

## 3. Key Data Flows

### 3.1 Application Submission
1.  **Citizen** fills multi-step form (React).
2.  Data validated client-side (Zod).
3.  Submitted to `POST /api/applications`.
4.  Backend validates payload.
5.  Files saved to Object Storage (Local/S3).
6.  Metadata saved to DB (`homestay_applications`).
7.  Audit log entry created.

### 3.2 Payment Processing (HimKosh)
1.  User initiates payment.
2.  Backend generates specific `merchantCode` and `checkSum` string.
3.  User redirected to HimKosh Gateway.
4.  On success/failure, HimKosh redirects to `/api/himkosh/callback`.
5.  Backend validates response signature.
6.  Transaction recorded in `himkosh_transactions`.
7.  Application status updated.

## 4. Deployment Architecture (Offline/On-Prem)
- **Orchestration**: PM2 (Process Manager).
- **Reverse Proxy**: Nginx (SSL termination, Static Asset Caching).
- **Directory Structure**:
    - `/opt/hptourism/app`: Application Logic.
    - `/opt/hptourism/data`: Persistent Data (Uploads, Logs).
    - `/opt/hptourism/backups`: Automated DB Benchmarks.
