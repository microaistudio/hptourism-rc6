# HPTourism Portal v0.7.1 - Technical Reference Guide

## 1. System Roles & Access Control
The system uses Role-Based Access Control (RBAC). Roles are strictly enforced via middleware.

| Role | Database Value | Description |
|------|----------------|-------------|
| **Property Owner** | `property_owner` | Citizen applying for homestay registration. |
| **Dealing Assistant (DA)** | `dealing_assistant` | District-level clerk. First line of verification. |
| **DTDO** | `district_tourism_officer` | District Tourism Development Officer. Final approval authority at district. |
| **Admin** | `admin` | System administrator (User management, limited settings). |
| **Super Admin** | `super_admin` | Full system access (Drop DB, Raw SQL, global settings). |

## 2. Database Schema Overview
Key tables in `shared/schema.ts`:

- **`users`**: Stores credentials, Role, District assignment.
- **`homestay_applications`**: The core record. Contains:
    - Status (`draft`, `submitted`, `under_scrutiny`, `approved`, `rejected`)
    - Owner Details (Name, Mobile, Aadhaar)
    - Property Details (Rooms, Address)
    - Workflow State (`da_id`, `dtdo_id`, `da_remarks`, etc.)
- **`documents`**: Metadata for uploaded files (linked to `S3` or local disk).
- **`payments`**: Records of fee calculations and payment attempts.
- **`himkosh_transactions`**: Raw logs of HimKosh gateway interactions.
- **`inspection_orders`** & **`inspection_reports`**: Workflow for physical verification.

## 3. Key API Routes

### 3.1 Authentication (`/api/auth`)
- `POST /register`: Create new Property Owner account.
- `POST /login`: Session-based login (Passport.js local strategy).
- `POST /logout`: Destroy session.
- `GET /user`: Get current session context (User object).

### 3.2 Applications (`/api/applications`)
- `GET /`: List applications (Filtered by Role/District).
- `POST /`: Submit new application.
- `PATCH /:id`: Update application status (DA/DTDO actions).
- `GET /:id/timeline`: Get audit trail for specific application.

### 3.3 Payments (`/api/himkosh`)
- `POST /initiate`: Generate checksum and redirect URL for payment.
- `POST /callback`: Webhook handler for HimKosh response.

### 3.4 Administration (`/api/admin`)
- `GET /users`: List all staff/users.
- `POST /users`: Create staff account.
- `POST /backup/create`: Trigger manual backup.

## 4. File Structure Convention

```
/opt/hptourism/app/
├── dist/                   # Compiled Backend
│   └── public/             # Static Frontend Assets (Vite Build)
├── server/                 # Backend Source Code
├── shared/                 # Shared Types/Schema (Frontend <-> Backend)
├── scripts/                # Utility Scripts (Install, Backup, Migration)
└── ecosystem.config.cjs    # PM2 Configuration
```

## 5. Configuration (Environment Variables)
Critical `.env` variables:
- `DATABASE_URL`: Postgres Connection String.
- `SESSION_SECRET`: Key for signing session cookies.
- `HIMKOSH_MERCHANT_CODE` / `HIMKOSH_KEY_FILE_PATH`: Payment Gateway Config.
- `LOCAL_OBJECT_DIR`: Path for file storage (default: `/opt/hptourism/data/uploads`).
